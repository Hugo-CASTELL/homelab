---
- name: Add the 802.1q module
  community.general.modprobe:
    name: 8021q
    state: present
    persistent: present

- name: Create VLANs logical interfaces
  ansible.builtin.template:
    src: ifupdown_vlan_if.j2
    dest: /etc/network/interfaces.d/vlans

- name: Add sourcing the vlans file to the ifupdown configuration
  ansible.builtin.lineinfile:
    path: /etc/network/interfaces
    line: "source /etc/network/interfaces.d/vlans"
    state: present

- name: Enable IP forwarding
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    reload: yes

- name: Install iptables
  ansible.builtin.package:
    name: iptables
    state: present

- name: Set default FORWARD policy to DROP
  ansible.builtin.iptables:
    chain: FORWARD
    policy: DROP

- name: Insert iptables rule for LAN -> WAN through NAT
  ansible.builtin.iptables:
    table: nat
    chain: POSTROUTING
    source: "{{ homelab_ip_subnet }}{{ homelab_ip_subnet_mask }}"
    out_interface: "{{ ethernet_interface }}.{{ vlan_id_wan }}"
    jump: MASQUERADE
    state: present

- name: Insert iptables rule allowing forwarding LAN -> WAN
  ansible.builtin.iptables:
    table: filter
    chain: FORWARD
    in_interface: "{{ ethernet_interface }}.{{ vlan_id_lan }}"
    out_interface: "{{ ethernet_interface }}.{{ vlan_id_wan }}"
    jump: ACCEPT
    state: present

- name: Insert iptables rule allowing forwarding WAN -> LAN
  ansible.builtin.iptables:
    table: filter
    chain: FORWARD
    in_interface: "{{ ethernet_interface }}.{{ vlan_id_wan }}"
    out_interface: "{{ ethernet_interface }}.{{ vlan_id_lan }}"
    ctstate: ESTABLISHED,RELATED
    jump: ACCEPT
    state: present

- name: Install iptables-persistent
  ansible.builtin.package:
    name: iptables-persistent
    state: present

- name: Save iptables rules
  ansible.builtin.shell: iptables-save > /etc/iptables/rules.v4
  changed_when: true

- name: Install build-essential if compiling or just use wget
  ansible.builtin.package:
    name: wget
    state: present

- name: Install bcrelay (via pptp-linux package)
  ansible.builtin.package:
    name: pptp-linux
    state: present

- name: Create systemd service for bcrelay
  ansible.builtin.copy:
    dest: /etc/systemd/system/bcrelay.service
    content: |
      [Unit]
      Description=Broadcast Relay Service
      After=network.target

      [Service]
      # -i defines the interfaces to bridge for broadcasts
      # -d runs it in the foreground for systemd logs
      ExecStart=/usr/sbin/bcrelay -d -i enp1s0.1 -i enp1s0.10
      Restart=always

      [Install]
      WantedBy=multi-user.target

- name: Enable and start bcrelay service
  ansible.builtin.systemd:
    name: bcrelay
    enabled: yes
    state: started
    daemon_reload: yes

- name: Restart network
  ansible.builtin.service:
    name: networking
    state: restarted
   
